<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HF & VHF Propagation Monitor & Alarm</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:20px;background:#0b1020;color:#e6eef8}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.5);margin-bottom:10px}
    h1{font-size:18px;margin:0 0 6px}
    .grid{display:grid;grid-template-columns:1fr 300px;gap:10px}
    .bands{display:grid;grid-template-columns:repeat(auto-fill, minmax(70px, 1fr));gap:6px;margin-top:8px}
    .band{padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);text-align:center;font-size:11px;cursor:pointer;min-width:70px}
    .open{border:2px solid #00ff99}
    .closed{opacity:0.6}
    label{display:block;margin-bottom:4px;font-size:12px}
    button{padding:6px 10px;border-radius:6px;border:none;background:#0ea5a2;color:#012;cursor:pointer;font-size:12px}
    small{color:#a8c0d8;font-size:11px}
    .muted{opacity:0.6;font-size:11px}
  </style>
</head>
<body>
  <div class="card">
    <h1>HF & VHF Propagation Monitor & Alarm</h1>
    <p>Monitors NOAA SWPC indices and estimates whether amateur bands are likely open. Enable per-band alarms and desktop notifications.</p>
    <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
      <label><input type="checkbox" id="notifyPermission"> Notifications & audio</label>
      <button id="testAlarm">Test alarm</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h2>Live Indices</h2>
        <div id="indices">Loading...</div>
      </div>

      <div class="card">
        <h2>Bands</h2>
        <div class="bands" id="bands"></div>
      </div>

      <div class="card">
        <h2>Log</h2>
        <div id="log" style="max-height:200px;overflow:auto;font-family:monospace;font-size:11px;background:rgba(0,0,0,0.12);padding:6px;border-radius:4px"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>Controls</h2>
        <label>Polling interval (s): <input id="interval" type="number" value="60" min="10" style="width:60px" /></label>
        <label>Enable auto alarms: <input id="autoAlarm" type="checkbox" checked /></label>
      </div>

      <div class="card">
        <h2>API status</h2>
        <div id="apiStatus">Not checked yet</div>
      </div>
    </div>
  </div>

  <script>
    const endpoints = {
      planetaryK: 'https://services.swpc.noaa.gov/json/planetary_k_index_1m.json',
      solarRadio: 'https://services.swpc.noaa.gov/json/solar-radio-flux.json'
    };

    const bands = [
      {name:'160m', key:'160', enabled:true},
      {name:'80m', key:'80', enabled:true},
      {name:'60m', key:'60', enabled:true},
      {name:'40m', key:'40', enabled:true},
      {name:'30m', key:'30', enabled:true},
      {name:'20m', key:'20', enabled:true},
      {name:'17m', key:'17', enabled:true},
      {name:'15m', key:'15', enabled:true},
      {name:'12m', key:'12', enabled:true},
      {name:'10m', key:'10', enabled:true},
      {name:'6m', key:'6', enabled:true},
      {name:'4m', key:'4', enabled:true},
      {name:'2m', key:'2', enabled:true},
      {name:'70cm', key:'70cm', enabled:true}
    ];

    const bandsDiv = document.getElementById('bands');
    bands.forEach(b=>{
      const el = document.createElement('div'); el.className='band closed'; el.id='band-'+b.key;
      el.innerHTML = `<strong>${b.name}</strong><div id="band-${b.key}-state">Unknown</div><label><input type="checkbox" class="alarmToggle" data-key="${b.key}" ${b.enabled? 'checked':''}/> Alarm</label>`;
      bandsDiv.appendChild(el);
    });

    const logEl = document.getElementById('log');
    const apiStatus = document.getElementById('apiStatus');

    function log(msg){ const t=new Date().toISOString(); logEl.innerHTML=`[${t}] ${msg}\n` + logEl.innerHTML; }

    async function fetchJson(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }catch(e){ log('Fetch error '+url+': '+e.message); throw e; }}

    function decideOpen(sfi,kp){
      const states={};
      if(sfi>=120 && kp<=4){ states['10']=true; states['15']=true; states['20']=true; }
      else if(sfi>=90 && kp<=4){ states['20']=true; states['15']=false; states['10']=false; }
      else { states['10']=false; states['15']=false; states['20']=false; }
      if(kp>=6){ states['40']=false; states['80']=false; }
      else{ states['40']=true; states['80']=true; }
      states['160']=(kp<=3 && sfi<120);
      // assume 60m/30m/17m/12m/6m/4m/2m/70cm open if kp<=5
      ['60','30','17','12','6','4','2','70cm'].forEach(k=>states[k]=kp<=5);
      return states;
    }

    let audioCtx=null;
    function ensureAudioContext(){
      if(audioCtx) return audioCtx;
      try{ const AC=window.AudioContext||window.webkitAudioContext; if(!AC){ log('Web Audio API not supported'); return null; } audioCtx=new AC(); return audioCtx; }
      catch(e){ log('Failed to create AudioContext: '+e.message); return null; }
    }

    function playBeep(durationMs=350,frequency=880){
      const ctx=ensureAudioContext(); if(!ctx){ log('No audio'); return; }
      try{
        const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=frequency;
        g.gain.value=0.0001; o.connect(g); g.connect(ctx.destination);
        const now=ctx.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.2,now+0.02);
        o.start(now); g.gain.exponentialRampToValueAtTime(0.0001,now+durationMs/1000); o.stop(now+durationMs/1000+0.05);
      }catch(e){ log('playBeep error: '+e.message); }
    }

    async function triggerAlarm(bandName){
      if(Notification && Notification.permission==='granted'){ try{ new Notification('Band Open', {body:`${bandName} looks open!`}); }catch(e){ log('Notification failed: '+e.message); } }
      const ctx=ensureAudioContext(); if(ctx && ctx.state==='suspended'){ ctx.resume().catch(()=>{}); }
      try{ playBeep(); }catch(e){ log('Alarm sound failed: '+e.message); }
      log('Alarm triggered for '+bandName);
    }

    let prevOpen={}; bands.forEach(b=>prevOpen[b.key]=false);

    async function update(){
      try{
        apiStatus.textContent='Fetching...';
        const [kpJson,sfiJson]=await Promise.all([fetchJson(endpoints.planetaryK),fetchJson(endpoints.solarRadio)]);
        const latestK=Array.isArray(kpJson)&&kpJson.length?kpJson[kpJson.length-1]:null;
        const kpValue=latestK?(latestK.kp||latestK.kp_est||latestK.value||0):0;
        const latestS=Array.isArray(sfiJson)&&sfiJson.length?sfiJson[sfiJson.length-1]:null;
        const sfiValue=latestS?(latestS.solar_flux_10cm||latestS['f107']||latestS['sfu']||latestS['observed_value']||latestS['flux']||0):0;
        apiStatus.textContent=`OK â€” Kp: ${kpValue}, SFI: ${sfiValue}`;
        document.getElementById('indices').innerHTML=`Kp: <strong>${kpValue}</strong><br/>SFI: <strong>${sfiValue}</strong><br/>Updated: ${new Date().toLocaleString()}`;
        const openStates=decideOpen(Number(sfiValue),Number(kpValue));
        bands.forEach(b=>{
          const el=document.getElementById('band-'+b.key);
          const stateEl=document.getElementById(`band-${b.key}-state`);
          const isOpen=!!openStates[b.key];
          el.className='band '+(isOpen?'open':'closed');
          stateEl.textContent=isOpen?'Likely open':'Likely closed';
          const alarmCheckbox=el.querySelector('.alarmToggle');
          const alarmEnabled=alarmCheckbox&&alarmCheckbox.checked;
          if(isOpen && alarmEnabled && !prevOpen[b.key] && document.getElementById('autoAlarm').checked){ triggerAlarm(b.name); }
          prevOpen[b.key]=isOpen;
        });
      }catch(e){ apiStatus.textContent='Error fetching data'; log('Update error: '+(e&&e.message?e.message:String(e))); }
    }

    update();
    let timer=null;
    function startTimer(){ const s=Math.max(10,Number(document.getElementById('interval').value||60)); if(timer)clearInterval(timer); timer=setInterval(update,s*1000); }
    startTimer();
    document.getElementById('interval').addEventListener('change',startTimer);
    document.getElementById('autoAlarm').addEventListener('change',()=>{ log('Auto alarm '+(document.getElementById('autoAlarm').checked?'enabled':'disabled')); });
    document.getElementById('notifyPermission').addEventListener('change',async(ev)=>{ if(ev.target.checked){ try{ const p=await Notification.requestPermission(); log('Notification permission: '+p); }catch(e){ log('Notification request failed: '+e.message); } }else{ log('Notifications & audio not requested'); } });
    document.getElementById('testAlarm').addEventListener('click',()=>{ triggerAlarm('TEST'); });
    document.querySelectorAll('.alarmToggle').forEach(cb=>{ cb.addEventListener('change',()=>{ log('Alarm for '+cb.dataset.key+' set to '+cb.checked); }); });
    window.addEventListener('error',e=>{ log('Error: '+(e&&e.message?e.message:String(e))); });
    if(typeof Notification==='undefined'){ document.getElementById('notifyPermission').disabled=true; document.getElementById('notifyPermission').parentElement.insertAdjacentHTML('beforeend','<span class="muted"> (Notifications not supported)</span>'); log('Notifications not supported'); }
  </script>
</body>
</html>
